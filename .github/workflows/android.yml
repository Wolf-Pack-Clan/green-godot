name: Android CI

on:
  #push:
  #  branches: [ "main" ]
  #pull_request:
  #  branches: [ "main" ]
  workflow_dispatch

permissions:
  contents: write
  actions: write

jobs:
  build:

    runs-on: ubuntu-latest
    container:
      image: quay.io/mechamorph/godot-android-build

    steps:
    - uses: actions/checkout@v4
    - name: set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"

    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          /android_sdk
        key: ${{ runner.os }}-android-cache
        restore-keys: |
          ${{ runner.os }}-android-cache
    
    - name: Set up Android SDK
      shell: bash
      run: |
        if [ ! -d "/android_sdk" ]; then
          wget -nv -O cmdline-tools.zip \
            https://dl.google.com/android/repository/commandlinetools-linux-13114758_latest.zip
          
          mkdir -p /android_sdk/cmdline-tools/latest
          unzip -q cmdline-tools.zip -d /tmp
          
          mv /tmp/cmdline-tools/* /android_sdk/cmdline-tools/latest/
          
          export ANDROID_SDK_ROOT=/android_sdk
          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
          echo "export ANDROID_SDK_ROOT=/android_sdk" >> /android_sdk/envars
          echo "export PATH=\$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:\$PATH" >> /android_sdk/envars
          echo "export ANDROID_HOME=$ANDROID_SDK_ROOT" >> /android_sdk/envars

          for i in {1..8}; do echo "y"; done | sdkmanager --licenses
          sdkmanager --install "platform-tools" "build-tools;30.0.3" "platforms;android-29" "cmake;3.10.2.4988404" "ndk;23.2.8568313"
          cat /android_sdk/envars
        fi
    
    - name: Build
      shell: bash
      run: |
        source /android_sdk/envars
        scons tools=no platform=android arch=armv7 lto=full \
          progress=yes debug_symbols=no module_gdnative_enabled=no \
          module_mobile_vr_enabled=no module_visual_script_enabled=no
        scons tools=no platform=android arch=arm64v8 lto=full \
          progress=yes debug_symbols=no module_gdnative_enabled=no \
          module_mobile_vr_enabled=no module_visual_script_enabled=no
        scons tools=no platform=android arch=x86 lto=full \
          progress=yes debug_symbols=no module_gdnative_enabled=no \
          module_mobile_vr_enabled=no module_visual_script_enabled=no
  
    - name: Build with Gradle
      shell: bash
      run: |
        source /android_sdk/envars
        cd platform/android/java
        chmod +x gradlew
        ./gradlew generateGodotTemplates
        cd ../../../
        zip -r -9 bin.zip bin

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: binaries
        path: bin.zip
